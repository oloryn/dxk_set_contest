#!/usr/bin/env py
"""
Create a DXKeeper script that will set QSOs from an ADIF file to a passed
contest id in DXKeeper
"""

import argparse
from typing import List, Dict
import winreg

import adif_io


def import_adif(adif_filename: str) -> List[Dict]:
    """Import QSOS from ADIF file"""

    qsos, _ = adif_io.read_from_file(adif_filename)

    return qsos


def main():
    """Set DXKeeper contest for QSOs in selected ADIF file"""

    # Get arguments rom command line
    parser = argparse.ArgumentParser(
        description="Set DXKeeper contest for QSOs in selected ADIF file"
    )

    parser.add_argument("contestname")
    parser.add_argument("adif_filename")

    args = parser.parse_args()

    # import QSOs from ADIF file
    qsos = import_adif(args.adif_filename)

    # Get DXKeeper Scripts directory from registry
    dxkeeper_reg = winreg.OpenKeyEx(
        winreg.HKEY_CURRENT_USER,
        "SOFTWARE\\VB and VBA Program Settings\\DXKeeper\\Configuration"
    )
    script_directory = winreg.QueryValueEx(dxkeeper_reg, "ScriptDirectory")[0]

    # Open script file
    script_filename = script_directory + "\\setcontestname.txt"
    with open(script_filename, 'a', encoding="utf-8") as script_file:
        for qso in qsos:
            print(qso)
            call = qso["CALL"]
            print("FILTER",
                  f"CALL='{call}')",
                  file=script_file)
            print("Modify CONTEST_ID", args.contestname, file=script_file)


main()
